<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5">
    <title>Bottin Annuaire Web Libre 2025 - Version Finale</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
    <style>
        /* Styles sp√©cifiques pour la version finale */
        .entry-actions {
            display: flex;
            gap: 8px;
            margin-top: 15px;
            padding-top: 10px;
            border-top: 1px solid var(--border-card);
        }
        
        .btn-small {
            padding: 6px 12px;
            font-size: 0.8rem;
            border-radius: 6px;
            min-height: 32px;
            background: transparent !important;
            color: var(--color-primary) !important;
            border: 1px solid var(--color-primary) !important;
        }
        
        .btn-small:hover {
            background: rgba(var(--color-primary-rgb), 0.15) !important;
            transform: translateY(-2px);
        }
        
        .btn-danger {
            color: var(--color-danger) !important;
            border-color: var(--color-danger) !important;
        }
        
        .btn-danger:hover {
            background: rgba(var(--color-danger-rgb), 0.15) !important;
        }
        
        /* Am√©liorations pour la V18 */
        .header-stats {
            display: flex;
            gap: 20px;
            margin-top: 15px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .stat {
            background: rgba(var(--color-primary-rgb), 0.15);
            padding: 10px 20px;
            border-radius: 10px;
            text-align: center;
            min-width: 120px;
        }
        
        .stat-number {
            font-size: 1.8rem;
            font-weight: 900;
            display: block;
            color: var(--color-primary) !important;
        }
        
        .stat-label {
            font-size: 0.85rem;
            color: var(--text-secondary) !important;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        /* Barre de recherche am√©lior√©e */
        .search-section {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 20px;
            align-items: center;
        }
        
        .search-input-wrapper {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 10px;
            background: var(--bg-card);
            border: 2px solid var(--border-card);
            border-radius: 12px;
            padding: 0 15px;
        }
        
        .search-input-wrapper i {
            color: var(--text-muted);
        }
        
        .search-input-wrapper input {
            flex: 1;
            background: transparent;
            border: none;
            color: var(--text-primary);
            padding: 12px 0;
            font-size: 15px;
        }
        
        .search-input-wrapper input:focus {
            outline: none;
        }
        
        /* Section de filtres actifs */
        .active-filters {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 10px;
            min-height: 40px;
        }
        
        .filter-tag {
            background: rgba(var(--color-primary-rgb), 0.2);
            color: var(--color-primary);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .filter-tag .remove {
            cursor: pointer;
            opacity: 0.7;
        }
        
        .filter-tag .remove:hover {
            opacity: 1;
        }
        
        /* Section de recherche avanc√©e */
        .advanced-search {
            display: none;
            margin-top: 15px;
            padding: 15px;
            background: var(--bg-card);
            border-radius: 12px;
            border: 1px solid var(--border-card);
        }
        
        .advanced-search.show {
            display: block;
        }
        
        .quick-dates {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 10px;
        }
        
        /* Boutons d'action am√©lior√©s */
        .btn-with-icon {
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        /* Modal am√©lior√© */
        .modal-body {
            max-height: 70vh;
            overflow-y: auto;
        }
        
        .form-help {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-top: 5px;
            display: block;
        }
        
        /* Responsive am√©lior√© */
        @media (max-width: 768px) {
            .header-stats {
                gap: 10px;
            }
            
            .stat {
                min-width: 100px;
                padding: 8px 15px;
            }
            
            .stat-number {
                font-size: 1.5rem;
            }
            
            .search-section {
                flex-direction: column;
            }
            
            .search-input-wrapper {
                width: 100%;
            }
        }
    </style>

<body class="theme-original">

    <!-- En-t√™te am√©lior√© -->
    <header class="header">
        <div class="container">
            <div class="header-top">
                <h1><i class="fas fa-address-book"></i> Bottin Annuaire Web Libre 2025</h1>
                <p class="subtitle">Annuaire collaboratif des organisations web libres et solidaires - Version Finale</p>
            </div>
            
            <div class="header-stats">
                <div class="header-stat">
                    <span class="stat-number" id="statTotal">0</span>
                    <span class="stat-label">Total</span>
                </div>
                <div class="header-stat">
                    <span class="stat-number" id="statCategories">0</span>
                    <span class="stat-label">Cat√©gories</span>
                </div>
                <div class="header-stat">
                    <span class="stat-number" id="statThemes">0</span>
                    <span class="stat-label">Th√®mes</span>
                </div>
                <div class="header-stat">
                    <span class="stat-number" id="filteredCount">0</span>
                    <span class="stat-label">Filtr√©es</span>
                </div>
            </div>
            
            <div class="controls">
                <div class="search-section">
                    <div class="search-input-wrapper">
                        <i class="fas fa-search"></i>
                        <input id="searchInput" type="text" placeholder="Rechercher organisations...">
                        <button id="btnAdvancedSearch" class="btn btn-secondary btn-with-icon">
                            <i class="fas fa-sliders-h"></i> Avanc√©e
                        </button>
                    </div>
                    <button id="btnClearFilters" class="btn btn-secondary btn-with-icon">
                        <i class="fas fa-times"></i> Effacer filtres
                    </button>
                    <select id="themeSelect" class="theme-select">
                        <option value="theme-minimal">‚ö™ Minimal</option>
                        <option value="theme-pastel">üé® Pastel</option>						
                        <option value="theme-light">‚òÄÔ∏è Clair</option>
                        <option value="theme-dark">üåô Sombre</option>
                        <option value="theme-gradient">üåà Gradient</option>
                        <option value="theme-luxe">üëë Luxe</option>
                        <option value="theme-nature-user">üåø Nature</option>
                        <option value="theme-retro">üìº R√©tro</option>
                        <option value="theme-techno">üíª Techno</option>
                        <option value="theme-futuriste">üöÄ Futuriste</option>
                        <option value="theme-original">üîµ Original</option>
                        <option value="theme-verre">üîç Verre Transparent</option>
                        <option value="theme-cyberpunk-v2">üåå Cyberpunk V2</option>
                        <option value="theme-cyberpunk">üîÆ Cyberpunk N√©on</option>
                        <option value="theme-neon">üí° N√©on Simple</option>
                        <option value="theme-jeu">üéÆ Jeu Vid√©o</option>
                        <option value="theme-nature-zen">‚òØÔ∏è Nature Zen</option>
                        <option value="theme-solarise">‚òÄÔ∏è Solaris√©</option>
                        <option value="theme-coucher">üåÖ Coucher de Soleil</option>
                        <option value="theme-pourpre">üëë Pourpre Royal</option>
                        <option value="theme-fete-foraine">üé° F√™te foraine</option>
                    </select>
                </div>
                
                <!-- Recherche avanc√©e -->
                <div id="advancedSearch" class="advanced-search">
                    <h3><i class="fas fa-cogs"></i> Recherche avanc√©e</h3>
                    <p>Filtrer par ann√©e :</p>
                    <div class="quick-dates">
                        <button onclick="filterByDate('2026')" class="btn-small">2026</button>
                        <button onclick="filterByDate('2025')" class="btn-small">2025</button>
                        <button onclick="filterByDate('2024')" class="btn-small">2024</button>
                        <button onclick="filterByDate('2023')" class="btn-small">2023</button>
                        <button onclick="filterByDate('2022')" class="btn-small">2022</button>
                        <button onclick="filterByDate('2021')" class="btn-small">2021</button>
                        <button onclick="filterByDate('2020')" class="btn-small">2020</button>
                    </div>
                </div>
                
                <!-- Filtres actifs -->
                <div id="activeFilters" class="active-filters"></div>
            </div>
        </div>
    </header>

    <main class="main-content">
        <div class="container two-columns">
            <!-- Colonne principale -->
            <section class="left-column">
                <div class="section-header">
                    <h2><i class="fas fa-list"></i> Organisations & Entreprises</h2>
                    <div class="stats">
                        <span id="filteredCountBadge" class="badge">0 entr√©es</span>
                        <div class="action-buttons">
                            <button id="btnImportJSON" class="btn btn-secondary btn-with-icon">
                                <i class="fas fa-file-import"></i> Import JSON
                            </button>
                            <input type="file" id="jsonFileInput" accept=".json" style="display: none;">
                            <button id="btnAddEntry" class="btn btn-secondary btn-with-icon">
                                <i class="fas fa-plus"></i> Ajouter
                            </button>
                            <select id="sortSelect">
                                <option value="name-asc">üî§ A-Z</option>
                                <option value="name-desc">üî§ Z-A</option>
                                <option value="category-asc">üè∑Ô∏è Cat√©gorie A-Z</option>
                                <option value="category-desc">üè∑Ô∏è Cat√©gorie Z-A</option>
                                <option value="date-desc">üìÖ R√©cent</option>
                                <option value="date-asc">üìÖ Ancien</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div id="entriesContainer" class="entries-grid"></div>
            </section>

            <!-- Colonne lat√©rale -->
            <aside class="right-column">
                <section>
                    <h2><i class="fas fa-chart-bar"></i> Top 10 th√©matiques</h2>
                    <div id="themesTop10" class="themes-grid"></div>
                </section>

                <section>
                    <h2><i class="fas fa-tags"></i> Toutes les cat√©gories</h2>
                    <div id="categoriesContainer" class="categories-grid"></div>
                </section>

                <section>
                    <h2><i class="fas fa-palette"></i> Toutes les th√©matiques</h2>
                    <div id="allThemesContainer" class="categories-grid"></div>
                </section>

                <section>
                    <h2><i class="fas fa-database"></i> Gestion des donn√©es</h2>
                    <div class="export-options">
                        <div class="export-row">
                            <label for="datasFormatSelect">Format datas.js:</label>
                            <select id="datasFormatSelect" class="form-select">
                                <option value="compact">Compact (1 ligne par entr√©e)</option>
                                <option value="ultra-compact">Ultra-Compact (toute la base sur 1 ligne)</option>
                                <option value="pretty">Pretty (format indent√©)</option>
                            </select>
                        </div>
                        <div class="export-buttons">
                            <button id="btnExportJSON" class="btn btn-secondary btn-with-icon">
                                <i class="fas fa-file-export"></i> Export JSON
                            </button>
                            <button id="btnExportFullJSON" class="btn btn-secondary btn-with-icon">
                                <i class="fas fa-file-alt"></i> Export Complet
                            </button>
                            <button id="btnExportDatasJS" class="btn btn-secondary btn-with-icon">
                                <i class="fas fa-file-code"></i> datas.js (V1)
                            </button>
                            <button id="btnExportTopThemes" class="btn btn-secondary btn-with-icon">
                                <i class="fas fa-chart-pie"></i> toptheme.js
                            </button>
                            <button id="btnResetTheme" class="btn btn-secondary btn-with-icon">
                                <i class="fas fa-sync-alt"></i> R√©init. th√®me
                            </button>
                            <button class="btn btn-secondary btn-with-icon" id="btnDownloadAll">
                                <i class="fas fa-download"></i> Tout t√©l√©charger
                            </button>
                            <button class="btn btn-danger btn-with-icon" id="btnResetData">
                                <i class="fas fa-trash-alt"></i> R√©init. donn√©es
                            </button>
                        </div>
                    </div>
                </section>
            </aside>
        </div>
    </main>

    <!-- Bouton retour en haut -->
    <button id="backToTop" class="back-to-top" title="Retour en haut">
        <i class="fas fa-arrow-up"></i>
    </button>

    <!-- Modale pour ajouter/modifier une entr√©e -->
    <div id="addEntryModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">‚ûï Ajouter une nouvelle entr√©e</h2>
                <button id="modalClose" class="modal-close">√ó</button>
            </div>
            <div class="modal-body">
                <form id="entryForm" class="modal-form">
                    <div class="form-group">
                        <label for="entryName">
                            <i class="fas fa-font"></i> Nom de l'organisation *
                        </label>
                        <input type="text" id="entryName" placeholder="Ex: Mon Organisation" required>
                    </div>
                    <div class="form-group">
                        <label for="entryCategory">
                            <i class="fas fa-tag"></i> Cat√©gorie
                        </label>
                        <input type="text" id="entryCategory" placeholder="Ex: Technologie, √âducation, etc.">
                        <small class="form-help">Laisser vide pour "Non cat√©goris√©"</small>
                    </div>
                    <div class="form-group">
                        <label for="entryDescription">
                            <i class="fas fa-align-left"></i> Description
                        </label>
                        <textarea id="entryDescription" placeholder="Description de l'organisation..."></textarea>
                    </div>
                    <div class="form-group">
                        <label for="entryUrl">
                            <i class="fas fa-link"></i> URL *
                        </label>
                        <input type="url" id="entryUrl" placeholder="https://example.com" required>
                        <small class="form-help">Doit commencer par http:// ou https://</small>
                    </div>
                    <div class="form-group">
                        <label for="entryDate">
                            <i class="fas fa-calendar-alt"></i> Date (ann√©e)
                        </label>
                        <input type="text" id="entryDate" placeholder="Ex: 2025">
                        <small class="form-help">Laisser vide pour "2025" par d√©faut</small>
                    </div>
                </form>
            </div>
            <div class="form-actions">
                <button type="button" id="cancelEntry" class="btn btn-secondary">Annuler</button>
                <button type="button" id="saveEntry" class="btn">Enregistrer</button>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-info">
                    <h3><i class="fas fa-address-book"></i> Bottin Annuaire Web Libre 2025</h3>
                    <p>Version Finale - 21 th√®mes CSS optimis√©s</p>
                    <p class="footer-note">
                        <i class="fas fa-info-circle"></i> 
                        Les donn√©es sont stock√©es localement dans votre navigateur. 
                        Pensez √† exporter vos donn√©es r√©guli√®rement.
                    </p>
                </div>
                <div class="footer-links">
                    <p><i class="fas fa-code"></i> D√©velopp√© avec HTML, CSS et JavaScript</p>
                    <p><i class="fas fa-heart"></i> Projet ouvert et participatif</p>
                </div>
            </div>
        </div>
    </footer>
    <script src="./datas.js"></script>
    <script src="./toptheme.js"></script>
    <script>
        // ===== CONFIGURATION =====
        const CONFIG = {
            appName: "Bottin Annuaire Web Libre 2025",
            version: "Finale",
            defaultTheme: "theme-original",
            storageKey: "bottinData_final"
        };

        // ===== √âTAT GLOBAL =====
        let state = {
            sites: [],
            activeCategories: [],
            activeThemes: [],
            searchTerm: "",
            currentTheme: CONFIG.defaultTheme,
            currentSort: "name-asc"
        };

        // ===== DONN√âES PAR D√âFAUT =====
        const DEFAULT_ENTRIES = [
            {
                n: "Constitutions Kulchatila",
                c: "Constitution",
                d: "Constitution des Communes Libres et Solidaires : D√©couvrez les diff√©rentes versions de notre projet constitutionnel innovant",
                u: "https://libresol2-5jaz4b32.manus.space",
                date: "2025",
                id: 1
            },
            {
                n: "Constitutions LMBMicro", 
                c: "Constitution",
                d: "Constitution des Communes Libres et Solidaires : D√©couvrez les diff√©rentes versions de notre projet constitutionnel innovant",
                u: "https://libresol2-5jaz4b32.manus.space",
                date: "2025",
                id: 2
            }
        ];

        // ===== INITIALISATION =====
        function initializeApp() {
            console.log(`üöÄ ${CONFIG.appName} v${CONFIG.version}`);
            loadData();
            setupTheme();
            setupEventListeners();
            applyFilters();
            updateStatistics();
            console.log("‚úÖ Application initialis√©e");
        }

        // ===== GESTION DES MESSAGES =====
        function showMessage(text, type = "info") {
            const messageId = 'msg-' + Date.now();
            const containerId = 'messageContainer';
            
            let container = document.getElementById(containerId);
            if (!container) {
                container = document.createElement('div');
                container.id = containerId;
                container.style.cssText = `
                    position: fixed;
                    top: 15px;
                    right: 15px;
                    z-index: 10000;
                    display: flex;
                    flex-direction: column;
                    align-items: flex-end;
                    gap: 10px;
                    max-height: calc(100vh - 30px);
                    pointer-events: none;
                    padding: 10px;
                    box-sizing: border-box;
                    overflow-y: hidden;                `;
                document.body.appendChild(container);
            }
            
            const messageElement = document.createElement('div');
            messageElement.id = messageId;
            messageElement.className = `message ${type}`;
            messageElement.style.cssText = `
                transform: translateX(100%);
                opacity: 0;
                pointer-events: auto;
                max-width: 320px;
                width: 100%;
                margin: 0;
                transition: all 0.3s ease;
				overflow-y: hidden;
            `;
            messageElement.innerHTML = `<p>${escapeHTML(text)}</p>`;
            
            container.appendChild(messageElement);
            
            setTimeout(() => {
                messageElement.style.transform = 'translateX(0)';
                messageElement.style.opacity = '1';
            }, 10);
            
            setTimeout(() => {
                messageElement.style.opacity = '0';
                messageElement.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    if (messageElement.parentNode) {
                        messageElement.remove();
                    }
                }, 300);
            }, 3000);
            
            return messageId;
        }

        // ===== GESTION DU TH√àME =====
        function setupTheme() {
            const savedTheme = localStorage.getItem('selectedTheme') || CONFIG.defaultTheme;
            state.currentTheme = savedTheme;
            document.body.className = savedTheme;
            
            const themeSelect = document.getElementById('themeSelect');
            if (themeSelect) themeSelect.value = savedTheme;
        }

        function changeTheme(themeName) {
            state.currentTheme = themeName;
            document.body.className = themeName;
            localStorage.setItem('selectedTheme', themeName);
            
            const themeSelect = document.getElementById('themeSelect');
            if (themeSelect) themeSelect.value = themeName;
            
            const themeDisplayName = themeName.replace('theme-', '').replace(/-/g, ' ');
            showMessage(`Th√®me: ${themeDisplayName}`, "info");
        }

        function resetTheme() {
            changeTheme(CONFIG.defaultTheme);
        }

        // ===== GESTION DES DONN√âES =====
        function loadData() {
            const savedData = localStorage.getItem(CONFIG.storageKey);
            
            if (savedData) {
                try {
                    const parsedData = JSON.parse(savedData);
                    state.sites = Array.isArray(parsedData) ? parsedData : [];
                    console.log(`üìÇ ${state.sites.length} entr√©es depuis localStorage`);
                } catch (e) {
                    console.error("Erreur localStorage:", e);
                    state.sites = [];
                }
            }
            
            if (state.sites.length === 0) {
                loadExternalOrDefault();
            } else {
                ensureDefaultEntries();
                applyFilters();
            }
        }

        function loadExternalOrDefault() {
            if (typeof window.sites !== 'undefined' && Array.isArray(window.sites)) {
                console.log("‚úÖ datas.js d√©tect√©");
                
                state.sites = window.sites.map(site => {
                    const entry = {
                        n: site.n || site.name || "",
                        u: site.u || site.url || "",
                        c: site.c || site.category || "Non cat√©goris√©",
                        d: site.d || site.description || "",
                        id: Date.now() + Math.random()
                    };
                    
                    entry.date = site.date || "2025";
                    
                    return entry;
                });
            } else {
                console.log("‚ö†Ô∏è datas.js non d√©tect√©, donn√©es par d√©faut");
                state.sites = [...DEFAULT_ENTRIES];
            }
            
            ensureDefaultEntries();
            saveToLocalStorage();
            applyFilters();
        }

        function ensureDefaultEntries() {
            DEFAULT_ENTRIES.forEach(defaultEntry => {
                const exists = state.sites.some(s => s.n === defaultEntry.n && s.u === defaultEntry.u);
                if (!exists) {
                    state.sites.push({
                        n: defaultEntry.n,
                        u: defaultEntry.u,
                        c: defaultEntry.c,
                        d: defaultEntry.d,
                        date: defaultEntry.date,
                        id: Date.now() + Math.random()
                    });
                }
            });
        }

        function saveToLocalStorage() {
            localStorage.setItem(CONFIG.storageKey, JSON.stringify(state.sites));
        }

        // ===== AFFICHAGE DES ENTREES AVEC √âDITION =====
        function displayEntries(list) {
            const container = document.getElementById('entriesContainer');
            const total = list.length;
            
            document.getElementById('filteredCount').textContent = total;
            document.getElementById('filteredCountBadge').textContent = `${total} entr√©e${total !== 1 ? 's' : ''}`;
            
            if (total === 0) {
                container.innerHTML = `
                    <div class="message info" style="grid-column: 1 / -1;">
                        <p style="margin-bottom: 20px; font-size: 1.2rem;">
                            Aucune organisation ne correspond aux filtres/recherche.
                        </p>
                        <button onclick="clearFilters()" class="btn">
                            üîÑ R√©initialiser les filtres
                        </button>
                    </div>`;
                return;
            }
            
            const defaultEntries = [];
            const otherEntries = [];
            
            list.forEach(site => {
                const isDefault = DEFAULT_ENTRIES.some(de => de.n === site.n && de.u === site.u);
                if (isDefault) {
                    defaultEntries.push(site);
                } else {
                    otherEntries.push(site);
                }
            });
            
            const sortedOther = sortEntries(otherEntries);
            const combinedEntries = [...defaultEntries, ...sortedOther];
            
            container.innerHTML = combinedEntries.map((site, index) => {
                const isDefault = DEFAULT_ENTRIES.some(de => de.n === site.n && de.u === site.u);
                const displayDate = site.date || "2025";
                const theme = getThemeForCategory(site.c);
                
                return `
                    <div class="entry-card" data-id="${site.id}">
                        <div class="entry-header">
                            <div class="entry-title">${escapeHTML(site.n)}</div>
                            <div class="entry-category">${escapeHTML(site.c)}</div>
                        </div>
                        <div class="entry-description">${escapeHTML(site.d || "Pas de description disponible")}</div>
                        <a href="${encodeURI(site.u)}" target="_blank" rel="noopener noreferrer" class="entry-url">
                            <i class="fas fa-link"></i> ${escapeHTML(truncateURL(site.u, 45))}
                        </a>
                        <div class="entry-meta">
                            <span>${escapeHTML(theme)}</span>
                            <span>${escapeHTML(displayDate)}</span>
                        </div>
                        <div class="entry-actions">
                            <button class="btn-small" onclick="editEntry('${site.id}')">
                                <i class="fas fa-edit"></i> Modifier
                            </button>
                            <button class="btn-small btn-danger" onclick="deleteEntry('${site.id}')">
                                <i class="fas fa-trash-alt"></i> Supprimer
                            </button>
                        </div>
                        ${isDefault ? '<div class="entry-star" margin-top: 15px; margin Right: 15px;>‚≠ê</div>' : ''}
                    </div>
                `;
            }).join('');
            
            updateActiveFilters();
        }

        // ===== FONCTIONS D'√âDITION =====
        let editingId = null;

        function editEntry(id) {
            const entry = state.sites.find(s => s.id === id);
            if (!entry) return;
            
            editingId = id;
            
            document.getElementById('entryName').value = entry.n;
            document.getElementById('entryCategory').value = entry.c;
            document.getElementById('entryDescription').value = entry.d || '';
            document.getElementById('entryUrl').value = entry.u;
            document.getElementById('entryDate').value = entry.date || '2025';
            
            document.getElementById('modalTitle').textContent = '‚úèÔ∏è Modifier l\'entr√©e';
            document.getElementById('saveEntry').textContent = 'Modifier';
            
            document.getElementById('addEntryModal').classList.add('show');
        }

        function saveEntry() {
            const name = document.getElementById('entryName').value.trim();
            const category = document.getElementById('entryCategory').value.trim() || "Non cat√©goris√©";
            const description = document.getElementById('entryDescription').value.trim();
            const url = document.getElementById('entryUrl').value.trim();
            const dateInput = document.getElementById('entryDate').value.trim();
            
            if (!url.startsWith('http://') && !url.startsWith('https://')) {
                showMessage("L'URL doit commencer par http:// ou https://", "error");
                return;
            }
            
            const date = dateInput || "2025";
            
            if (!name) {
                showMessage("Le nom est requis", "error");
                return;
            }
            
            if (!url) {
                showMessage("L'URL est requise", "error");
                return;
            }
            
            if (editingId) {
                const entryIndex = state.sites.findIndex(s => s.id === editingId);
                if (entryIndex === -1) return;
                
                const duplicate = state.sites.some((s, index) => 
                    index !== entryIndex && s.n === name && s.u === url
                );
                
                if (duplicate) {
                    showMessage("Une autre entr√©e avec le m√™me nom et URL existe d√©j√†", "warning");
                    return;
                }
                
                state.sites[entryIndex] = {
                    ...state.sites[entryIndex],
                    n: name,
                    c: category,
                    d: description,
                    u: url,
                    date: date
                };
                
                showMessage("Entr√©e modifi√©e avec succ√®s", "success");
                editingId = null;
            } else {
                const exists = state.sites.some(s => s.n === name && s.u === url);
                if (exists) {
                    showMessage("Cette entr√©e existe d√©j√†", "warning");
                    return;
                }
                
                const newEntry = {
                    n: name,
                    c: category,
                    d: description,
                    u: url,
                    date: date,
                    id: Date.now() + Math.random()
                };
                
                state.sites.push(newEntry);
                showMessage("Entr√©e ajout√©e avec succ√®s", "success");
            }
            
            saveToLocalStorage();
            applyFilters();
            hideAddEntryModal();
        }

        function deleteEntry(id) {
            if (confirm("√ätes-vous s√ªr de vouloir supprimer cette entr√©e ?")) {
                const entry = state.sites.find(s => s.id === id);
                if (entry && DEFAULT_ENTRIES.some(de => de.n === entry.n && de.u === entry.u)) {
                    showMessage("Les entr√©es par d√©faut ne peuvent pas √™tre supprim√©es", "warning");
                    return;
                }
                
                state.sites = state.sites.filter(s => s.id !== id);
                saveToLocalStorage();
                applyFilters();
                showMessage("Entr√©e supprim√©e", "info");
            }
        }

        // ===== FONCTIONS MANQUANTES =====
        function updateActiveFilters() {
            const container = document.getElementById('activeFilters');
            const filters = [];
            
            if (state.searchTerm) {
                filters.push({
                    text: `Recherche: ${state.searchTerm}`,
                    remove: () => {
                        state.searchTerm = '';
                        document.getElementById('searchInput').value = '';
                        applyFilters();
                    }
                });
            }
            
            state.activeCategories.forEach(cat => {
                filters.push({
                    text: `Cat√©gorie: ${cat}`,
                    remove: () => {
                        const index = state.activeCategories.indexOf(cat);
                        if (index > -1) state.activeCategories.splice(index, 1);
                        applyFilters();
                    }
                });
            });
            
            state.activeThemes.forEach(theme => {
                filters.push({
                    text: `Th√®me: ${theme}`,
                    remove: () => {
                        const index = state.activeThemes.indexOf(theme);
                        if (index > -1) state.activeThemes.splice(index, 1);
                        applyFilters();
                    }
                });
            });
            
            container.innerHTML = filters.map(filter => `
                <div class="filter-tag">
                    <span>${escapeHTML(filter.text)}</span>
                    <span class="remove" onclick="filter.remove()">√ó</span>
                </div>
            `).join('');
        }

        function filterByDate(year) {
            state.searchTerm = year;
            document.getElementById('searchInput').value = year;
            applyFilters();
        }

        function downloadAllData() {
            const allData = {
                metadata: {
                    app: CONFIG.appName,
                    version: CONFIG.version,
                    exportDate: new Date().toISOString(),
                    count: state.sites.length
                },
                sites: state.sites,
                themes: Object.entries(getThemeCounts()).map(([theme, count]) => ({ theme, count }))
            };
            
            const blob = new Blob([JSON.stringify(allData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `bottin-complet-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            showMessage("Toutes les donn√©es t√©l√©charg√©es", "success");
        }

        function resetAllData() {
            if (confirm("√ätes-vous s√ªr de vouloir supprimer toutes les donn√©es ajout√©es ?\nSeules les entr√©es par d√©faut seront conserv√©es.")) {
                state.sites = [...DEFAULT_ENTRIES];
                saveToLocalStorage();
                applyFilters();
                showMessage("Donn√©es r√©initialis√©es", "success");
            }
        }

        function exportFullInfoJSON() {
            const allData = state.sites.map(s => ({
                name: s.n,
                url: s.u,
                category: s.c,
                description: s.d || "",
                date: s.date || "2025",
                theme: getThemeForCategory(s.c),
                metadata: {
                    id: s.id,
                    added: new Date().toISOString()
                }
            }));
            
            const blob = new Blob([JSON.stringify(allData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `bottin-info-complet-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            showMessage("Export complet JSON termin√©", "success");
        }

        function getThemeCounts() {
            const counts = {};
            state.sites.forEach(site => {
                const theme = getThemeForCategory(site.c);
                counts[theme] = (counts[theme] || 0) + 1;
            });
            return counts;
        }

        // ===== FONCTIONS EXISTANTES √Ä CONSERVER =====
        function sortEntries(list) {
            const sorted = [...list];
            
            switch(state.currentSort) {
                case 'name-asc': return sorted.sort((a, b) => a.n.localeCompare(b.n));
                case 'name-desc': return sorted.sort((a, b) => b.n.localeCompare(a.n));
                case 'category-asc': return sorted.sort((a, b) => a.c.localeCompare(b.c) || a.n.localeCompare(b.n));
                case 'category-desc': return sorted.sort((a, b) => b.c.localeCompare(a.c) || a.n.localeCompare(b.n));
                case 'date-desc': return sorted.sort((a, b) => {
                    const dateA = a.date || "2025";
                    const dateB = b.date || "2025";
                    return dateB.localeCompare(dateA);
                });
                case 'date-asc': return sorted.sort((a, b) => {
                    const dateA = a.date || "2025";
                    const dateB = b.date || "2025";
                    return dateA.localeCompare(dateB);
                });
                default: return sorted;
            }
        }

        function displayTopThemes(list) {
            const container = document.getElementById('themesTop10');
            const counts = {};
            
            list.forEach(site => {
                if (site.c && site.c.trim()) {
                    counts[site.c] = (counts[site.c] || 0) + 1;
                }
            });
            
            const top = Object.entries(counts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);
            
            if (top.length === 0) {
                container.innerHTML = `<div class="message">Aucune th√©matique disponible</div>`;
                return;
            }
            
            container.innerHTML = top.map(([category, count], index) => {
                const theme = getThemeForCategory(category);
                return `
                    <div class="theme-card" onclick="toggleThemeFilter('${escapeHTML(theme)}')">
                        <div class="theme-header">
                            <div class="theme-rank">${index + 1}</div>
                            <h3>${escapeHTML(category)}</h3>
                        </div>
                        <p class="theme-count">${count} organisation${count !== 1 ? 's' : ''}</p>
                        <p class="theme-desc">Th√®me: ${theme}</p>
                        <button class="btn btn-secondary" onclick="event.stopPropagation();toggleCategory('${escapeHTML(category)}')">
                            üîç Filtrer
                        </button>
                    </div>
                `;
            }).join('');
        }

        function displayCategories(list) {
            const container = document.getElementById('categoriesContainer');
            const counts = {};
            
            list.forEach(site => {
                if (site.c && site.c.trim()) {
                    counts[site.c] = (counts[site.c] || 0) + 1;
                }
            });
            
            const sorted = Object.entries(counts).sort((a, b) => a[0].localeCompare(b[0]));
            
            if (sorted.length === 0) {
                container.innerHTML = `<div class="message">Aucune cat√©gorie disponible</div>`;
                return;
            }
            
            container.innerHTML = sorted.map(([category, count]) => `
                <button class="category-item ${state.activeCategories.includes(category) ? 'active' : ''}" 
                        onclick="toggleCategory('${escapeHTML(category)}')">
                    ${escapeHTML(category)} <span class="cat-count">(${count})</span>
                </button>
            `).join('');
        }

        function displayAllThemes(list) {
            const container = document.getElementById('allThemesContainer');
            const themeCounts = {};
            
            list.forEach(site => {
                const theme = getThemeForCategory(site.c);
                themeCounts[theme] = (themeCounts[theme] || 0) + 1;
            });
            
            const sorted = Object.entries(themeCounts).sort((a, b) => a[0].localeCompare(b[0]));
            
            if (sorted.length === 0) {
                container.innerHTML = `<div class="message">Aucune th√©matique disponible</div>`;
                return;
            }
            
            container.innerHTML = sorted.map(([theme, count]) => `
                <button class="category-item ${state.activeThemes.includes(theme) ? 'active' : ''}" 
                        onclick="toggleThemeFilter('${escapeHTML(theme)}')">
                    ${escapeHTML(theme)} <span class="cat-count">(${count})</span>
                </button>
            `).join('');
        }

        function applyFilters() {
            let filtered = [...state.sites];
            
            if (state.searchTerm) {
                const search = state.searchTerm.toLowerCase();
                filtered = filtered.filter(site =>
                    (site.n && site.n.toLowerCase().includes(search)) ||
                    (site.d && site.d.toLowerCase().includes(search)) ||
                    (site.c && site.c.toLowerCase().includes(search)) ||
                    (site.u && site.u.toLowerCase().includes(search))
                );
            }
            
            if (state.activeCategories.length > 0) {
                filtered = filtered.filter(site => 
                    state.activeCategories.includes(site.c)
                );
            }
            
            if (state.activeThemes.length > 0) {
                filtered = filtered.filter(site => 
                    state.activeThemes.includes(getThemeForCategory(site.c))
                );
            }
            
            displayEntries(filtered);
            displayTopThemes(filtered);
            displayCategories(filtered);
            displayAllThemes(filtered);
            updateStatistics();
        }

        function toggleCategory(category) {
            const index = state.activeCategories.indexOf(category);
            if (index > -1) {
                state.activeCategories.splice(index, 1);
            } else {
                state.activeCategories.push(category);
            }
            applyFilters();
        }

        function toggleThemeFilter(theme) {
            const index = state.activeThemes.indexOf(theme);
            if (index > -1) {
                state.activeThemes.splice(index, 1);
            } else {
                state.activeThemes.push(theme);
            }
            applyFilters();
        }

        function clearFilters() {
            state.activeCategories = [];
            state.activeThemes = [];
            state.searchTerm = "";
            state.currentSort = "name-asc";
            
            document.getElementById('searchInput').value = "";
            document.getElementById('sortSelect').value = "name-asc";
            document.getElementById('advancedSearch').classList.remove('show');
            
            applyFilters();
            showMessage("Filtres r√©initialis√©s", "info");
        }

        function updateStatistics() {
            const total = state.sites.length;
            const categories = new Set(state.sites.map(s => s.c).filter(Boolean)).size;
            const themes = new Set(state.sites.map(s => getThemeForCategory(s.c)).filter(Boolean)).size;
            
            document.getElementById('statTotal').textContent = total;
            document.getElementById('statCategories').textContent = categories;
            document.getElementById('statThemes').textContent = themes;
        }

        // ===== UTILITAIRES =====
        function getThemeForCategory(category) {
            if (!category) return "Autre";
            
            const themeMap = {
                "Constitution": ["Constitution", "Gouvernance", "Droit"],
                "Technologie": ["Technologie", "Informatique", "D√©veloppement", "Programmation"],
                "Gouvernance": ["Gouvernance", "Politique", "Administration", "Gestion"],
                "√âducation": ["√âducation", "Formation", "Universit√©", "√âcole"],
                "Culture": ["Culture", "Arts", "Musique", "Litt√©rature"],
                "√âcologie": ["√âcologie", "Environnement", "Climat", "D√©veloppement durable"],
                "Sant√©": ["Sant√©", "M√©decine", "Bien-√™tre", "Soins"],
                "√âconomie": ["√âconomie", "Finance", "Business", "Commerce"],
                "Social": ["Social", "Communaut√©", "Association", "Solidarit√©"],
                "Science": ["Science", "Recherche", "Innovation", "Technologie"],
                "Sport": ["Sport", "Loisir", "Activit√© physique"],
                "M√©dia": ["M√©dia", "Presse", "Communication", "Journalisme"]
            };
            
            for (const [theme, categories] of Object.entries(themeMap)) {
                if (categories.includes(category)) {
                    return theme;
                }
            }
            
            return "Autre";
        }

        function escapeHTML(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            let escaped = div.innerHTML;
            escaped = escaped.replace(/'/g, '&#39;').replace(/"/g, '&quot;');
            return escaped;
        }

        function truncateURL(url, max = 45) {
            if (!url) return '';
            if (url.length <= max) return url;
            return url.substring(0, max) + '...';
        }

        // ===== GESTION DES MODALES =====
        function showAddEntryModal() {
            editingId = null;
            document.getElementById('entryForm').reset();
            document.getElementById('modalTitle').textContent = '‚ûï Ajouter une nouvelle entr√©e';
            document.getElementById('saveEntry').textContent = 'Ajouter';
            document.getElementById('addEntryModal').classList.add('show');
        }

        function hideAddEntryModal() {
            document.getElementById('addEntryModal').classList.remove('show');
            document.getElementById('entryForm').reset();
            editingId = null;
        }

        // ===== √âV√âNEMENTS =====
        function setupEventListeners() {
            // Recherche
            const searchInput = document.getElementById('searchInput');
            let searchTimeout;
            
            searchInput.addEventListener('input', (e) => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    state.searchTerm = e.target.value.toLowerCase().trim();
                    applyFilters();
                }, 300);
            });
            
            // Recherche avanc√©e
            document.getElementById('btnAdvancedSearch').addEventListener('click', () => {
                const advancedSearch = document.getElementById('advancedSearch');
                advancedSearch.classList.toggle('show');
            });
            
            // Th√®me
            document.getElementById('themeSelect').addEventListener('change', (e) => {
                changeTheme(e.target.value);
            });
            
            // Tri
            document.getElementById('sortSelect').addEventListener('change', (e) => {
                state.currentSort = e.target.value;
                applyFilters();
            });
            
            // Import
            document.getElementById('btnImportJSON').addEventListener('click', () => {
                document.getElementById('jsonFileInput').click();
            });
            document.getElementById('jsonFileInput').addEventListener('change', importJSON);
            
            // Export
            document.getElementById('btnExportJSON').addEventListener('click', exportJSON);
            document.getElementById('btnExportDatasJS').addEventListener('click', exportDatasJS);
            document.getElementById('btnExportTopThemes').addEventListener('click', exportTopThemes);
            
            // Boutons
            document.getElementById('btnClearFilters').addEventListener('click', clearFilters);
            document.getElementById('btnResetTheme').addEventListener('click', resetTheme);
            
            // Ajout d'entr√©e
            document.getElementById('btnAddEntry').addEventListener('click', showAddEntryModal);
            document.getElementById('modalClose').addEventListener('click', hideAddEntryModal);
            document.getElementById('cancelEntry').addEventListener('click', hideAddEntryModal);
            document.getElementById('saveEntry').addEventListener('click', saveEntry);
            
            // Fermer la modale
            document.getElementById('addEntryModal').addEventListener('click', (e) => {
                if (e.target.id === 'addEntryModal') hideAddEntryModal();
            });
            
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') hideAddEntryModal();
            });
            
            // Bouton retour en haut
            const backToTopBtn = document.getElementById('backToTop');
            if (backToTopBtn) {
                backToTopBtn.addEventListener('click', () => {
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                });
                
                window.addEventListener('scroll', () => {
                    backToTopBtn.style.display = window.scrollY > 200 ? 'block' : 'none';
                });
            }
        }

        // ===== FONCTIONS D'IMPORT/EXPORT =====
        function importJSON(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    if (!Array.isArray(data)) {
                        showMessage("Le fichier doit contenir un tableau JSON", "error");
                        return;
                    }
                    
                    let added = 0;
                    data.forEach(item => {
                        if (item && item.n && item.u) {
                            if (!item.u.startsWith('http://') && !item.u.startsWith('https://')) {
                                console.warn("URL invalide pour l'entr√©e:", item.n);
                                return;
                            }
                            
                            const entry = {
                                n: item.n.toString().trim(),
                                u: item.u.toString().trim(),
                                c: (item.c || "Non cat√©goris√©").toString().trim(),
                                d: (item.d || "").toString().trim(),
                                date: item.date || "2025",
                                id: Date.now() + Math.random()
                            };
                            
                            const exists = state.sites.some(s => s.n === entry.n && s.u === entry.u);
                            if (!exists) {
                                state.sites.push(entry);
                                added++;
                            }
                        }
                    });
                    
                    ensureDefaultEntries();
                    
                    if (added > 0) {
                        saveToLocalStorage();
                        applyFilters();
                        showMessage(`${added} entr√©e(s) import√©e(s)`, "success");
                    } else {
                        showMessage("Aucune nouvelle entr√©e", "info");
                    }
                    
                } catch (error) {
                    showMessage("Erreur d'import: " + error.message, "error");
                }
            };
            
            reader.readAsText(file);
            event.target.value = "";
        }

        function exportJSON() {
            const data = state.sites.map(s => ({
                n: s.n,
                u: s.u,
                c: s.c,
                d: s.d || "",
                date: s.date || "2025"
            }));
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `bottin-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            showMessage("Export JSON termin√©", "success");
        }

        function exportDatasJS() {
            const format = document.getElementById('datasFormatSelect').value;
            let content = '// datas.js V1 - Bottin Annuaire Web Libre 2025\n';
            content += '// Format V1 (avec date optionnelle)\n\n';
            content += 'window.sites = ';
            
            const data = state.sites.map(s => ({
                n: s.n,
                u: s.u,
                c: s.c,
                d: s.d || "",
                date: s.date || "2025"
            }));
            
            if (format === 'compact') {
                content += JSON.stringify(data);
            } else {
                content += JSON.stringify(data, null, 2);
            }
            
            content += ';\n';
            
            const blob = new Blob([content], { type: 'application/javascript' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'datas.js';
            link.click();
            
            showMessage("Export datas.js V1 termin√©", "success");
        }

        function exportTopThemes() {
            const counts = {};
            state.sites.forEach(s => {
                if (s.c) counts[s.c] = (counts[s.c] || 0) + 1;
            });
            
            const themes = Object.entries(counts)
                .map(([theme, count]) => ({ theme, count, description: `${count} organisation(s)` }))
                .sort((a, b) => b.count - a.count);
            
            const content = `// toptheme.js - Th√©matiques principales\nwindow.TOP_THEMES = ${JSON.stringify(themes, null, 2)};`;
            
            const blob = new Blob([content], { type: 'application/javascript' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'toptheme.js';
            link.click();
            
            showMessage("Export toptheme.js termin√©", "success");
        }

        // ===== D√âMARRAGE =====
        document.addEventListener('DOMContentLoaded', initializeApp);

        // ===== FONCTIONS GLOBALES =====
        window.toggleCategory = toggleCategory;
        window.toggleThemeFilter = toggleThemeFilter;
        window.clearFilters = clearFilters;
        window.changeTheme = changeTheme;
        window.showAddEntryModal = showAddEntryModal;
        window.editEntry = editEntry;
        window.deleteEntry = deleteEntry;
        window.filterByDate = filterByDate;
        window.downloadAllData = downloadAllData;
        window.resetAllData = resetAllData;
        window.exportFullInfoJSON = exportFullInfoJSON;
    </script>    
    <!-- Chargement des scripts dans le bon ordre -->
    <script src="app.js"></script>
</body>
</html>