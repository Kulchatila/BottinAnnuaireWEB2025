// ===== Variables globales =====
let activeCategories = [];
let activeThemes = [];
let searchTerm = "";

// ===== Initialisation =====
document.addEventListener('DOMContentLoaded', () => {
  // Stats globales
  document.getElementById('totalCount').textContent = sites.length;
  document.getElementById('categoryCount').textContent = [...new Set(sites.map(s => s.c).filter(Boolean))].length;
  updateSideStats();

  // Affichage initial
  applyFilters();

  // Recherche
  const searchEl = document.getElementById('searchInput');
  if (searchEl) {
    searchEl.addEventListener('input', e => {
      searchTerm = e.target.value.toLowerCase();
      applyFilters();
    });
  }

  // S√©lecteur de th√®me CSS
  const themeSel = document.getElementById('themeSelector');
  if (themeSel) {
    themeSel.addEventListener('change', e => {
      document.body.className = e.target.value;
    });
  }

  // Exports
  const btnExportJSON = document.getElementById('btnExportJSON');
  if (btnExportJSON) btnExportJSON.addEventListener('click', exportJSONAll);

  const btnExportDatasJS = document.getElementById('btnExportDatasJS');
  if (btnExportDatasJS) {
    btnExportDatasJS.addEventListener('click', () => {
      const format = document.getElementById('datasFormatSelect').value;
      exportDatasJS(format);
    });
  }

  // Bouton Statistiques (optionnel)
  const statsBtn = document.getElementById('btnStats');
  if (statsBtn) {
    statsBtn.addEventListener('click', showStats);
  }
});

// ===== Affichage des entr√©es =====
function displayEntries(list) {
  const container = document.getElementById('entriesContainer');
  if (!container) return;
  container.innerHTML = '';
  list.forEach((site, index) => {
    container.innerHTML += `
      <div class="entry-card fade-in">
        <div class="entry-header">
          <div class="entry-title">${site.n}</div>
          <div class="entry-category">${site.c || "Divers"}</div>
        </div>
        <div class="entry-description">${site.d || ""}</div>
        <a href="${site.u}" target="_blank" class="entry-url">Visiter</a>
      </div>
    `;
    if ((index + 1) % 10 === 0) {
      container.innerHTML += `<div class="back-to-top"><a href="#top">‚¨Ü Retour en haut</a></div>`;
    }
  });
}

// ===== Affichage du Top 10 th√©matiques (dynamique depuis sites filtr√©s) =====
function displayTopThemes(list) {
  const container = document.getElementById('themesTop10');
  if (!container) return;
  const counts = {};
  list.forEach(s => { if (s.c) counts[s.c] = (counts[s.c] || 0) + 1; });
  const sorted = Object.entries(counts).sort((a, b) => b[1] - a[1]).slice(0, 10);
  container.innerHTML = sorted.map(([theme, count], i) => `
    <div class="theme-card ${activeThemes.includes(theme) ? 'active' : ''}" 
         onclick="toggleTheme('${theme}')">
      <div class="theme-rank">${i + 1}</div>
      <h3>${theme}</h3>
      <p>${count} organisations</p>
    </div>
  `).join('');
}

// ===== Affichage des cat√©gories (valeurs uniques de s.c ‚Äî interactif) =====
function displayCategories(list) {
  const container = document.getElementById('categoriesContainer');
  if (!container) return;
  const counts = {};
  list.forEach(s => { if (s.c) counts[s.c] = (counts[s.c] || 0) + 1; });
  const sorted = Object.entries(counts).sort((a, b) => a[0].localeCompare(b[0]));
  container.innerHTML = sorted.map(([cat, count]) => `
    <div class="category-item ${activeCategories.includes(cat) ? 'active' : ''}" 
         onclick="toggleCategory('${cat}')">${cat} (${count})</div>
  `).join('');
}

// ===== Affichage de toutes les th√©matiques (vue globale depuis topThemes) =====
function displayAllThemes() {
  const container = document.getElementById('allThemesContainer');
  if (!container) return;
  if (!Array.isArray(topThemes)) {
    container.innerHTML = `<div class="category-item">Aucune th√©matique (topThemes manquant)</div>`;
    return;
  }
  container.innerHTML = topThemes.map(t => `
    <div class="theme-card">
      <h3>${t.theme}</h3>
      <p>${t.count} organisations</p>
      <p>${t.description}</p>
    </div>
  `).join('');
}

// ===== Filtres multi-s√©lection =====
function toggleCategory(cat) {
  if (activeCategories.includes(cat)) {
    activeCategories = activeCategories.filter(c => c !== cat);
  } else {
    activeCategories.push(cat);
  }
  applyFilters();
}

function toggleTheme(theme) {
  if (activeThemes.includes(theme)) {
    activeThemes = activeThemes.filter(t => t !== theme);
  } else {
    activeThemes.push(theme);
  }
  applyFilters();
}

// ===== Application des filtres =====
function applyFilters() {
  let filtered = sites;

  // Filtre recherche
  if (searchTerm) {
    filtered = filtered.filter(s =>
      (s.n && s.n.toLowerCase().includes(searchTerm)) ||
      (s.d && s.d.toLowerCase().includes(searchTerm)) ||
      (s.c && s.c.toLowerCase().includes(searchTerm))
    );
  }

  // Filtre cat√©gories
  if (activeCategories.length > 0) {
    filtered = filtered.filter(s => activeCategories.includes(s.c));
  }

  // Filtre th√©matiques
  if (activeThemes.length > 0) {
    filtered = filtered.filter(s => activeThemes.includes(s.c));
  }

  displayEntries(filtered);
  displayTopThemes(filtered);   // Top 10 dynamique
  displayCategories(filtered);  // Cat√©gories interactives
  displayAllThemes();           // Toutes les th√©matiques (vue globale statique)
}

// ===== Stats =====
function updateSideStats() {
  const total = sites.length;
  const categories = new Set(sites.map(s => s.c).filter(Boolean)).size;
  document.getElementById('sideTotalCount').textContent = total;
  document.getElementById('sideCategoryCount').textContent = categories;
}

function showStats() {
  const total = sites.length;
  const categories = new Set(sites.map(s => s.c).filter(Boolean)).size;
  alert(`üìä Statistiques globales:\n\nOrganisations: ${total}\nCat√©gories: ${categories}`);
}

// ===== Exports =====
function exportJSONAll() {
  const dataStr = JSON.stringify(sites, null, 2);
  const blob = new Blob([dataStr], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  downloadURL(url, 'bottin-annuaire-2025.json');
}

function exportDatasJS(format = 'compact') {
  const header = '// datas.js g√©n√©r√©\n';
  let sitesStr = '';

  if (format === 'compact') {
    sitesStr = 'window.sites = [\n' + sites.map(s => JSON.stringify(s)).join('\n') + '\n];\n';
  } else {
    sitesStr = 'window.sites = ' + JSON.stringify(sites, null, 2) + ';\n';
  }

  const fullStr = header + sitesStr;
  const blob = new Blob([fullStr], { type: 'application/javascript' });
  const url = URL.createObjectURL(blob);
  downloadURL(url, `datas-${format}.js`);
}

function downloadURL(url, filename) {
  const link = document.createElement('a');
  link.href = url;
  link.download = filename;
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  URL.revokeObjectURL(url);
}
